# ADR-005: Security Posture and Rate Limiting

**Status:** Accepted  
**Date:** 2025-12-05  
**Deciders:** ARC SAGA Architecture Team  
**Context:** Production security requires input validation, rate limiting, CORS restrictions, and secret protection.

## Decision

ARC SAGA implements defense-in-depth security:

1. **Input Validation**: Pydantic models + custom validators (`arc_saga/validators.py`)
2. **Rate Limiting**: SlowAPI middleware with per-endpoint limits
3. **CORS Restrictions**: VSCode webview + localhost only
4. **Secret Masking**: Automatic redaction in logs
5. **HTTPS Enforcement**: TLS required for production (not enforced in dev)

## Implementation Details

### Input Validation

**Payload Size Limits:**

- Message content: 100KB max
- Metadata keys: 128 chars max
- Search query: 1KB max

**Validation Functions:**

- `validate_capture_request()`: Source, role, content, metadata
- `validate_search_request()`: Query, limit (1-500)
- `validate_perplexity_request()`: Query non-empty

### Rate Limiting (SlowAPI)

Per-endpoint limits:

- `/capture`: 30 requests/minute
- `/search`: 60 requests/minute
- `/perplexity/ask`: 20 requests/minute
- `/thread/{id}`: 60 requests/minute

**Rate Limit Response:**

```json
{
  "detail": "Rate limit exceeded. Please retry shortly."
}
```

HTTP 429 status code.

### CORS Configuration

Allowed origins:

- `vscode-webview://*` (VSCode extension)
- `http://localhost:*` (local development)

**Production CORS:**

- TBD: Specific domain allowlist
- HTTPS required

### Secret Masking

Automatic redaction in `log_with_context()`:

- Keys containing: `token`, `key`, `secret`, `password`, `api_key`, `access_token`, `refresh_token`
- Replaced with: `***REDACTED***`

### Security Headers (Future)

Planned for Phase 3:

- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: DENY`
- `Strict-Transport-Security` (HSTS)

## Threat Model

**Addressed:**

- ✅ SQL Injection: Parameterized queries (SQLite/PostgreSQL)
- ✅ XSS: Input validation + content type restrictions
- ✅ Secret Leakage: Automatic log masking
- ✅ Rate Limiting: SlowAPI middleware
- ✅ CORS: Restricted origins

**Future Enhancements (Phase 3):**

- OWASP Top 10 review
- Dependency vulnerability scanning (Dependabot)
- Security headers middleware
- API key rotation

## Consequences

**Positive:**

- Production-ready security posture
- OWASP compliance foundation
- Audit-friendly (all security controls documented)

**Negative:**

- Rate limiting may impact legitimate high-volume users (adjustable)
- CORS restrictions require explicit allowlist updates

**Mitigations:**

- Rate limits configurable via environment variables
- CORS allowlist easily extensible

## References

- OWASP Top 10: https://owasp.org/www-project-top-ten/
- SlowAPI Documentation: https://slowapi.readthedocs.io/
- Secret Masking: `arc_saga/error_instrumentation.py::_sanitize_secrets()`
