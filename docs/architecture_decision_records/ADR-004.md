# ADR-004: Observability Strategy (Prometheus + OTEL)

**Status:** Accepted  
**Date:** 2025-12-05  
**Deciders:** ARC SAGA Architecture Team  
**Context:** Production observability requires metrics, tracing, and structured logging with correlation IDs.

## Decision

ARC SAGA uses a three-tier observability stack:

1. **Structured Logging**: JSON logs with correlation IDs (`arc_saga/error_instrumentation.py`)
2. **Prometheus Metrics**: Request latency, error counts, circuit breaker states (`arc_saga/observability.py`)
3. **OpenTelemetry Tracing**: Distributed tracing for async operations (optional, graceful fallback)

## Implementation Details

### Structured Logging

Every log entry includes:

- `request_id`: Unique per request lifecycle
- `trace_id`: Distributed tracing correlation
- `span_id`: Operation-level tracking
- `timestamp`: ISO 8601 UTC
- `service_name`: Component identifier

**Secret Masking**: Automatically redacts keys containing: token, key, secret, password, api_key, access_token, refresh_token.

### Prometheus Metrics

Exposed at `/metrics/prometheus`:

- `arc_saga_request_latency_ms`: Histogram (path, method, status)
- `arc_saga_request_total`: Counter (path, method, status)
- `arc_saga_errors_total`: Counter (path, method, status)

**Label Cardinality**: Paths normalized to 120 chars, query params excluded to prevent explosion.

### OpenTelemetry Tracing

Optional integration (graceful fallback if OTEL not installed):

- HTTP request spans (`http.{method}`)
- Async operation spans (`instrument_async_operation`)
- Correlation ID propagation via span attributes

## Metrics Endpoints

1. **`/metrics`**: JSON format (existing health monitor)
2. **`/metrics/prometheus`**: Prometheus scrape endpoint (new)
3. **`/health/detailed`**: Full system diagnostics

## Consequences

**Positive:**

- Complete request lifecycle visibility
- Performance bottleneck identification
- Security compliance (secret masking)
- Production-ready monitoring

**Negative:**

- Minimal overhead (~1-2ms per request)
- Optional dependencies (OTEL, prometheus_client)

**Mitigations:**

- Graceful degradation (metrics disabled if deps missing)
- Low-cardinality labels prevent metric explosion
- Sampling can be enabled for high-traffic scenarios

## Configuration

**Environment Variables:**

- `OTEL_EXPORTER_OTLP_ENDPOINT`: Optional OTEL collector endpoint
- `PROMETHEUS_PORT`: Optional custom Prometheus scrape port

**Defaults:**

- OTEL: Disabled (no-op if not installed)
- Prometheus: Enabled (503 if client not installed)

## References

- Prometheus Client Library: https://github.com/prometheus/client_python
- OpenTelemetry Python: https://opentelemetry.io/docs/instrumentation/python/
- Correlation ID pattern: `arc_saga/error_instrumentation.py`
